var app=app||{};app.model={locations:["320 Pioneer Way, Mountain View, CA 94041, United States","80 W El Camino Real, Mountain View, CA 94040, United States","Grant Park Plaza, 1040 Grant Road #350, Mountain View, CA 94040, United States","635 W Dana St, Mountain View, CA 94041, United States","53 W El Camino Real, Mountain View, CA 94040, United States","Grant Park Plaza, 1040 Grant Rd, Mountain View, CA 94040, United States","145 E Dana St, Mountain View, CA 94041, United States","701 E El Camino Real, Mountain View, CA 94040, United States","Grant Park Plaza, 1350 Grant Rd Suite 8, Mountain View, CA 94040, United States","750 Castro St, Mountain View, CA 94041, United States"],googleMap:'<div id="map"></div>',currentMarker:null,mapOptions:{disableDefaultUI:!0},service:null,getInfoWindow:function(){return new google.maps.InfoWindow},auth:{consumerKey:"CczkBNRj_eaoMgqd0o4n1A",consumerSecret:"jfMHfpHubGUZWRBXVAjTaTMRrbo",accessToken:"0IKGCVVzoRIpB2WKQtFPYa_stRAlzmYO",accessTokenSecret:"JEoYIbjq2NJkywPo7HBu_pG4GgE",serviceProvider:{signatureMethod:"HMAC-SHA1"}},placeDetailsByPlaceId:function(e){var a=e.place_id,o={placeId:a};app.ViewModel.service.getDetails(o,app.model.placeCallBack)},placeCallBack:function(e,a){a==google.maps.places.PlacesServiceStatus.OK?(console.log("place: "),console.log(e),app.model.getYelpData(e)):window.alert("Error, Try Again")},getYelpData:function(e){console.log("about to request yelp data");var a="business",o=e.formatted_address,r=3,t={consumerSecret:app.model.auth.consumerSecret,tokenSecret:app.model.auth.accessTokenSecret};parameters=[],parameters.push(["term",a]),parameters.push(["limit",r]),parameters.push(["location",o]),parameters.push(["callback","cb"]),parameters.push(["oauth_consumer_key",app.model.auth.consumerKey]),parameters.push(["oauth_consumer_secret",app.model.auth.consumerSecret]),parameters.push(["oauth_token",app.model.auth.accessToken]),parameters.push(["oauth_signature_method","HMAC-SHA1"]);var n={action:"http://api.yelp.com/v2/search",method:"GET",parameters:parameters};OAuth.setTimestampAndNonce(n),OAuth.SignatureMethod.sign(n,t);var l=OAuth.getParameterMap(n.parameters);l.oauth_signature=OAuth.percentEncode(l.oauth_signature),$.ajax({url:n.action,data:l,cache:!0,dataType:"jsonp",jsonpCallback:"cb"}).done(function(a,o,r){console.log(a);var t=$("#marker-tbl-row").html(),n=Handlebars.compile(t),l=a.businesses;l.name=e.name;var i=n(l);if(null!==app.model.currentMarker.infoWindow){var p=app.ViewModel.map,s=app.model.currentMarker;app.model.currentMarker.infoWindow.setContent(i),console.log(app.model.currentMarker.infoWindow),app.model.currentMarker.infoWindow.open(p,s)}else console.log("infowindow is null")}).fail(app.model.handleError)},handleError:function(e){window.alert("Error: "+e.toString()+"has occurred. Please Try again"),console.log(e.message)}},app.ViewModel=function(){function e(){var e="There has been an error.";e+="\n\nRefresh page and this error should go away.";var a='<div id="carousel-example-generic" class="carousel slide"data-ride="carousel"><div class="carousel-inner" role="listbox"><div class="item active"><img  src="images/google-map-api.png" class="img-responsive " alt="Responsive image" /><div class="carousel-caption set-caption"><div class="full-width text-center"><h3 class="error">'+e.toUpperCase()+"</h3></div></div></div></div>";return $("#view").html(a),!0}var a=this;a.timedOut=!1,a.markers=ko.observableArray([]),$("#mapDiv").append(app.model.googleMap);try{app.ViewModel.map=new google.maps.Map(document.getElementById("map"),app.model.mapOptions)}catch(o){console.log("error: "+o.message),a.stop=e()}finally{}app.ViewModel.service=new google.maps.places.PlacesService(app.ViewModel.map),app.ViewModel.createMapMarker=function(e){var o=e.geometry.location.lat(),r=e.geometry.location.lng(),t=e.name,n=window.mapBounds,l=new google.maps.Marker({map:app.ViewModel.map,position:e.geometry.location,title:t,place_id:e.place_id,draggable:!0,animation:google.maps.Animation.DROP});l.infoWindow=app.model.getInfoWindow(),a.markers.push(l),app.model.locations.length===a.markers().length&&(timedOut=!1,clearTimeout(a.requestTimer),console.log("timer reset")),google.maps.event.addListener(l,"click",function(){null!==app.model.currentMarker&&null!==app.model.currentMarker.infoWindow&&app.model.currentMarker.infoWindow.close(),app.model.currentMarker=null,app.model.currentMarker=l,app.model.placeDetailsByPlaceId(app.model.currentMarker)}),l.addListener("click",app.ViewModel.toggleBounce),n.extend(new google.maps.LatLng(o,r)),app.ViewModel.map.fitBounds(n),app.ViewModel.map.setCenter(n.getCenter())},app.ViewModel.toggleBounce=function(){a.markers().forEach(function(e){e.setAnimation(null)}),app.model.currentMarker.setAnimation(google.maps.Animation.BOUNCE)},a.callback=function(e,a){if(console.log("in callback"),a!=google.maps.places.PlacesServiceStatus.OK)return void window.alert("Error, Try Again");app.ViewModel.createMapMarker(e[0]);var o=e[0];console.log(o)},this.pinPoster=function(){app.model.locations.forEach(function(e){var o={query:e};app.ViewModel.service.textSearch(o,a.callback)})},window.mapBounds=new google.maps.LatLngBounds,a.stop||a.pinPoster(),a.requestTimer=setTimeout(function(){timedOut=!0,console.log("Request timed out."),e()},1e4),a.addMarker=function(e,o){a.markers()[e].setMap(o)},a.setMapOnAll=function(e){for(var o=0;o<a.markers().length;o++)a.markers()[o].setMap(e)},a.filterMarkers=function(e){a.setMapOnAll(null),a.markers().forEach(function(o,r){var t=o.title;e||a.setMapOnAll(app.ViewModel.map),-1!==t.toLowerCase().indexOf(e)&&a.addMarker(r,app.ViewModel.map)})},a.filter=ko.observable(""),a.initialize=!0,a.filteredItems=ko.computed(function(){var e=a.filter().toLowerCase();return e?(a.filterMarkers(e),ko.utils.arrayFilter(a.markers(),function(a){return-1!==a.title.toLowerCase().indexOf(e)})):(a.filterMarkers(e),a.markers())}),this.showInfowindow=function(e){null!==app.model.currentMarker&&null!==app.model.currentMarker.infoWindow&&app.model.currentMarker.infoWindow.close(),a.filter(""),app.model.currentMarker=null,app.model.currentMarker=e,app.ViewModel.toggleBounce(),app.model.placeDetailsByPlaceId(app.model.currentMarker)},window.addEventListener("resize",function(e){app.ViewModel.map.fitBounds(window.mapBounds),console.log("resized")})},ko.applyBindings(new app.ViewModel);