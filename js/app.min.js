var app=app||{};app.model={locations:[{formatted_address:"320 Pioneer Way, Mountain View, CA 94041, United States"},{formatted_address:"80 W El Camino Real, Mountain View, CA 94040, United States"},{formatted_address:"Grant Park Plaza, 1040 Grant Road #350, Mountain View, CA 94040, United States"},{formatted_address:"635 W Dana St, Mountain View, CA 94041, United States"},{formatted_address:"53 W El Camino Real, Mountain View, CA 94040, United States"},{formatted_address:"Grant Park Plaza, 1040 Grant Rd, Mountain View, CA 94040, United States"},{formatted_address:"145 E Dana St, Mountain View, CA 94041, United States"},{formatted_address:"701 E El Camino Real, Mountain View, CA 94040, United States"},{formatted_address:"Grant Park Plaza, 1350 Grant Rd Suite 8, Mountain View, CA 94040, United States"},{formatted_address:"750 Castro St, Mountain View, CA 94041, United States"}],googleMap:'<div id="map"></div>',currentMarker:null,mapOptions:{disableDefaultUI:!0},service:null,getInfoWindow:function(){return new google.maps.InfoWindow},auth:{consumerKey:"CczkBNRj_eaoMgqd0o4n1A",consumerSecret:"jfMHfpHubGUZWRBXVAjTaTMRrbo",accessToken:"0IKGCVVzoRIpB2WKQtFPYa_stRAlzmYO",accessTokenSecret:"JEoYIbjq2NJkywPo7HBu_pG4GgE",serviceProvider:{signatureMethod:"HMAC-SHA1"}},placeDetailsByPlaceId:function(e){var a=e.place_id,t={placeId:a};app.ViewModel.service.getDetails(t,app.model.placeCallBack)},placeCallBack:function(e,a){a==google.maps.places.PlacesServiceStatus.OK?(console.log("place: "),console.log(e),app.model.getYelpData(e)):window.alert("Error, Try Again")},getYelpData:function(e){console.log("about to request yelp data");var a="business",t=e.formatted_address,o={consumerSecret:app.model.auth.consumerSecret,tokenSecret:app.model.auth.accessTokenSecret};parameters=[],parameters.push(["term",a]),parameters.push(["location",t]),parameters.push(["callback","cb"]),parameters.push(["oauth_consumer_key",app.model.auth.consumerKey]),parameters.push(["oauth_consumer_secret",app.model.auth.consumerSecret]),parameters.push(["oauth_token",app.model.auth.accessToken]),parameters.push(["oauth_signature_method","HMAC-SHA1"]);var r={action:"http://api.yelp.com/v2/search",method:"GET",parameters:parameters};OAuth.setTimestampAndNonce(r),OAuth.SignatureMethod.sign(r,o);var n=OAuth.getParameterMap(r.parameters);n.oauth_signature=OAuth.percentEncode(n.oauth_signature),$.ajax({url:r.action,data:n,cache:!0,dataType:"jsonp",jsonpCallback:"cb",success:function(a,t,o){if(console.log(a),content=null,content='<div class="row"><div class="col-xs-12"><h3>'+e.name+'</h3><h5><strong>The 3 other nearby places via Yelp</strong></h5><table class="table table-striped"><tr><th> Business </th><th> Rated </th><th class="hidden-xs"> Phone </th></tr><tr><td> '+a.businesses[0].name+" </td><td> "+a.businesses[0].rating+' </td><td class="hidden-xs"> '+a.businesses[0].display_phone+" </td></tr><tr><td> "+a.businesses[1].name+" </td><td> "+a.businesses[1].rating+' </td><td class="hidden-xs"> '+a.businesses[1].display_phone+" </td></tr><tr><td> "+a.businesses[2].name+" </td><td> "+a.businesses[2].rating+' </td><td class="hidden-xs"> '+a.businesses[2].display_phone+" </td></tr></table></div></div>",console.log(content),null!==app.model.currentMarker.infoWindow){var r=app.ViewModel.map,n=app.model.currentMarker;console.log("about to open infowindow"),console.log(content),console.log("map: "),console.log(app.ViewModel.map),console.log(app.model.currentMarker.infoWindow),app.model.currentMarker.infoWindow.setContent(content),console.log(app.model.currentMarker.infoWindow),app.model.currentMarker.infoWindow.open(r,n)}else console.log("infowindow is null")},error:app.model.handleError})},handleError:function(e){window.alert("Error: "+e.toString()),console.log(e.message)}},app.ViewModel=function(){function e(){var e="There has been an error.";e+="\n\nRefresh page and this error should go away.";var a='<div id="carousel-example-generic" class="carousel slide"data-ride="carousel"><div class="carousel-inner" role="listbox"><div class="item active"><img  src="images/google-map-api.png" class="img-responsive " alt="Responsive image" /><div class="carousel-caption set-caption"><div class="full-width text-center"><h3 class="error">'+e.toUpperCase()+"</h3></div></div></div></div>";return $("#view").html(a),!0}var a=this;a.timedOut=!1,a.markers=ko.observableArray([]),$("#mapDiv").append(app.model.googleMap);try{app.ViewModel.map=new google.maps.Map(document.getElementById("map"),app.model.mapOptions)}catch(t){console.log("error: "+t.message),a.stop=e()}finally{}app.ViewModel.service=new google.maps.places.PlacesService(app.ViewModel.map),app.ViewModel.createMapMarker=function(e){var t=e.geometry.location.lat(),o=e.geometry.location.lng(),r=e.name,n=window.mapBounds,s=new google.maps.Marker({map:app.ViewModel.map,position:e.geometry.location,title:r,place_id:e.place_id,draggable:!0,animation:google.maps.Animation.DROP});s.infoWindow=app.model.getInfoWindow(),a.markers.push(s),app.model.locations.length===a.markers().length&&(timedOut=!1,clearTimeout(a.requestTimer),console.log("timer reset")),google.maps.event.addListener(s,"click",function(){null!==app.model.currentMarker&&null!==app.model.currentMarker.infoWindow&&app.model.currentMarker.infoWindow.close(),app.model.currentMarker=null,app.model.currentMarker=s,app.model.placeDetailsByPlaceId(app.model.currentMarker)}),s.addListener("click",app.ViewModel.toggleBounce),n.extend(new google.maps.LatLng(t,o)),app.ViewModel.map.fitBounds(n),app.ViewModel.map.setCenter(n.getCenter())},app.ViewModel.toggleBounce=function(){a.markers().forEach(function(e){e.setAnimation(null)}),app.model.currentMarker.setAnimation(google.maps.Animation.BOUNCE)},a.callback=function(e,a){if(console.log("in callback"),a!=google.maps.places.PlacesServiceStatus.OK)return void window.alert("Error, Try Again");app.ViewModel.createMapMarker(e[0]);var t=e[0];console.log(t)},this.pinPoster=function(){app.model.locations.forEach(function(e){var t={query:e.formatted_address};app.ViewModel.service.textSearch(t,a.callback)})},window.mapBounds=new google.maps.LatLngBounds,a.stop||a.pinPoster(),a.requestTimer=setTimeout(function(){timedOut=!0,console.log("Request timed out."),e()},1e4),a.addMarker=function(e,t){a.markers()[e].setMap(t)},a.setMapOnAll=function(e){for(var t=0;t<a.markers().length;t++)a.markers()[t].setMap(e)},a.filterMarkers=function(e){a.setMapOnAll(null),a.markers().forEach(function(t,o){var r=t.title;e||a.setMapOnAll(app.ViewModel.map),-1!==r.toLowerCase().indexOf(e)&&a.addMarker(o,app.ViewModel.map)})},a.filter=ko.observable(""),a.initialize=!0,a.filteredItems=ko.computed(function(){var e=a.filter().toLowerCase();return e?($(".list-group-item").removeClass("hiddenx"),a.filterMarkers(e),ko.utils.arrayFilter(a.markers(),function(a){return-1!==a.title.toLowerCase().indexOf(e)})):($(".list-group-item ").addClass("hiddenx"),a.filterMarkers(e),a.markers())}),this.showInfowindow=function(e){null!==app.model.currentMarker&&null!==app.model.currentMarker.infoWindow&&app.model.currentMarker.infoWindow.close(),$("#filter").val(""),$(".list-group-item ").addClass("hiddenx"),app.model.currentMarker=null,app.model.currentMarker=e,app.ViewModel.toggleBounce(),app.model.placeDetailsByPlaceId(app.model.currentMarker)},window.addEventListener("resize",function(e){app.ViewModel.map.fitBounds(window.mapBounds),console.log("resized")})},ko.applyBindings(new app.ViewModel);